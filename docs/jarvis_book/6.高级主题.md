# 7. 高级主题

本章面向希望深度定制和挖掘 Jarvis 潜力的用户，将介绍一些高级配置和功能。

## 7.1 模型组配置

在不同的任务场景下，您可能希望使用不同的AI模型组合。例如，使用一个强大的模型进行复杂的代码生成（“思考”模型），同时使用一个快速、经济的模型处理常规对话（“普通”模型）。**模型组**功能就是为此设计的。

### 配置方法

在您的全局配置文件 `~/.jarvis/config.yaml` 中，您可以定义 `JARVIS_MODEL_GROUPS` 列表，并用 `JARVIS_MODEL_GROUP` 来选择当前激活的组。

```yaml
# 1. 定义可用的模型组
JARVIS_MODEL_GROUPS:
  # 模型组一：使用 Kimi 作为主力
  - kimi:
      JARVIS_PLATFORM: kimi
      JARVIS_MODEL: k1.5
      JARVIS_THINKING_PLATFORM: kimi
      JARVIS_THINKING_MODEL: k1.5-thinking
      JARVIS_MAX_TOKEN_COUNT: 8192 # 特定于该组的配置

  # 模型组二：使用 AI8 作为主力
  - ai8:
      JARVIS_PLATFORM: ai8
      JARVIS_MODEL: gemini-2.5-pro
      # 如果不指定思考模型, 将自动使用常规模型
      # JARVIS_THINKING_PLATFORM: ai8
      # JARVIS_THINKING_MODEL: gemini-2.5-pro

# 2. 选择要激活的模型组
JARVIS_MODEL_GROUP: kimi
```

### 配置优先级

Jarvis 按以下顺序（从高到低）应用配置：
1.  **独立环境变量**: 直接设置的 `JARVIS_PLATFORM`, `JARVIS_MODEL` 等。会覆盖所有其他设置。
2.  **模型组配置**: 由 `JARVIS_MODEL_GROUP` 选中的配置。
3.  **代码默认值**: 如果以上均未配置，则使用系统内置的默认模型（如 `yuanbao`）。

## 7.2 命令替换与快捷指令

为了提升交互效率，Jarvis 支持一种特殊的**命令替换**机制。当您在交互式输入中单独输入一个被 `'` 包围的特定标签时，它会自动触发一个预定义的高级操作。

### 内置快捷指令

| 标签                  | 功能描述                                   |
| --------------------- | ------------------------------------------ |
| `'Summary'`           | 让AI总结当前会话内容，并清空历史记录。     |
| `'Clear'`             | 强制清空当前会话，开始一个全新的对话。     |
| `'ToolUsage'`         | 显示所有已加载的可用工具及其使用方法。     |
| `'ReloadConfig'`      | 重新加载 `~/.jarvis/config.yaml` 配置文件。 |
| `'Web'`               | 触发网页搜索。                             |
| `'FindRelatedFiles'`  | 查找与当前任务或需求相关的文件。           |
| `'Fix'`               | 指示AI修复上一步操作或代码中遇到的问题。   |
| `'Check'`             | 对代码执行静态分析，检查错误和风格问题。   |
| `'SaveSession'`       | 保存当前会话状态到文件并退出。             |

### 自定义快捷指令

您还可以在配置文件中定义自己的快捷指令。

```yaml
# ~/.jarvis/config.yaml
JARVIS_REPLACE_MAP:
  my_check: # 定义一个名为 'my_check' 的快捷指令
    template: "请使用pylint对src目录下的所有python文件进行代码质量检查，并报告问题"
    description: "运行自定义的pylint检查"
    append: false # false表示替换用户输入, true表示追加到用户输入
```

配置后，当您在 `jvs` 中输入 `'my_check'` 时，它会被自动替换为 `template` 中的长指令。

## 7.3 自定义代理 (`jarvis-agent` / `ja`)

虽然 `jvs` 和 `jca` 等预置代理能满足大部分需求，但有时您可能需要一个具有特定“人设”、特定工具集和特定行为模式的代理。`jarvis-agent` (`ja`) 就是用于创建和运行这种高度自定义代理的工具。

### 代理定义文件

自定义代理的核心是一个 YAML 格式的定义文件。

```yaml
# my_db_admin_agent.yaml

# 代理的名称
name: "数据库管理员"

# 系统提示词，定义了代理的身份和行为准则
system_prompt: |
  你是一个专业的数据库管理员(DBA)。
  你的职责是帮助用户管理数据库。
  你只能使用提供的 `sql_query` 和 `db_schema` 工具。
  在执行任何写操作（INSERT, UPDATE, DELETE）之前，必须向用户请求确认。

# 限定此代理可用的工具列表 (可选)
# 如果不指定, 代理将可以使用所有已加载的工具
# tools:
#   - sql_query
#   - db_schema

# 是否自动执行AI生成的下一步指令 (建议为false以增加可控性)
auto_complete: false

# 任务结束后是否需要生成总结
need_summary: true
```

### 使用方法

您可以使用 `-c` 或 `--agent_definition` 参数来加载您的代理定义文件。

```bash
# 使用自定义的DBA代理，并分配一个初始任务
ja -c my_db_admin_agent.yaml -t "查询 users 表中有多少条记录"
```

通过这种方式，您可以创建出各种各样专注于特定领域的专家代理，如“文档撰写专家”、“k8s运维专家”或“安全分析专家”，极大地扩展了 Jarvis 的应用场景。
