# 4. 使用指南

本章是 Jarvis 的实用操作手册，将详细介绍主要命令的用法、参数和常见场景示例。

## 4.1 通用交互技巧

无论您使用哪个 Jarvis 工具，掌握以下交互技巧都将极大提升您的效率。

### 1. 快捷键 (多行输入模式)

在需要您输入多行文本（如 `jvs` 或 `jca` 的交互模式）时，可以使用以下快捷键：

| 快捷键        | 功能                                               |
|---------------|----------------------------------------------------|
| `@`           | 触发自动补全，可提示文件路径和特殊指令。           |
| `Tab`         | 在弹出的补全建议列表中进行选择。                   |
| `Enter`       | 在补全列表打开时应用选中项，否则用于换行。         |
| `Ctrl + J`    | 提交您的多行输入，开始执行任务。                   |
| `Ctrl + C`    | 取消当前的输入操作。                               |
| `Ctrl + O`    | 复制AI的上一条回复到系统剪贴板，方便您使用。     |

### 2. 提示词技巧 (Prompting)

编写高质量的提示词是让 Jarvis 发挥最大潜能的关键。

- **明确角色与目标**: 在任务开始时，清晰地告诉Jarvis它应该扮演什么角色，以及最终要达成的目标是什么。
  > **例**: "你现在是一个资深的运维专家。我的目标是排查并解决一个 Kubernetes Pod 启动失败的问题。"
- **提供上下文**: 使用 `@` 符号引入文件或代码片段，为 Jarvis 提供必要的上下文信息。AI 无法处理它“看不见”的内容。
  > **例**: "请分析 `@./src/main.py` 这个文件中的代码，并找出潜在的性能瓶颈。"
- **使用特殊指令**: 在输入时使用 `@` 触发并选择特殊指令，以执行特定操作。
  > **例**: 输入 `@Summary` 并提交，可以要求 Jarvis 对之前的对话进行总结。
- **分解复杂任务**: 对于复杂的任务，将其分解为更小、更具体的步骤，并引导 Jarvis 逐步完成。

### 3. 人工介入与控制 (Human-in-the-Loop)

Jarvis 的一个核心特性是支持在任务执行的任意阶段进行人工介入。

- **执行前确认**: 在执行可能产生影响的操作（如运行脚本、修改文件）之前，Jarvis 会暂停并请求您的确认 `[Y/n]`。这是第一层防护。

- **思考后介入 (`Ctrl+C`)**: 这是最关键的介入方式。
  - 当 AI 正在“思考”（即大模型正在生成下一步计划）时，您可以随时按下 `Ctrl+C`。
  - Jarvis **不会立即打断**模型的思考，而是会**等待当前思考步骤完成**（即API返回结果）。
  - 在**执行**模型生成的计划（如调用工具）**之前**，系统会检测到中断信号，暂停执行并提示您：`"模型交互期间被中断，请输入用户干预信息："`。
  - 这为您提供了一个审查并否决 AI 下一步行动的宝贵机会。您可以输入新指令来纠正它，或直接拒绝它即将执行的工具调用。

- **工具调用裁决**: 这是“思考后介入”的具体体现。当您中断了一个即将发生的工具调用时，系统会询问您是否继续处理该工具。这让您拥有对每一步具体操作的最终决定权。

- **强制退出 (多次`Ctrl+C`)**: 如果您希望立即终止整个 Jarvis 程序，而不想等待当前思考步骤完成，可以**快速连续按下 `Ctrl+C` 五次以上（或长按）**。这将触发系统的强制退出机制。

---

## 4.2 通用代理 (`jarvis` / `jvs`)

`jvs` 是您的通用AI助手，适用于各种开放式、非特异性的任务。

### 核心能力
-   任务分析与规划
-   多工具协同
-   系统交互
-   方法论应用

### 常用参数
| 参数                | 描述                             |
| ------------------- | -------------------------------- |
| `-t`, `--task`      | 直接从命令行提供初始任务         |
| `-f`, `--config`    | 指定自定义配置文件的路径         |
| `--llm_type`        | 临时指定LLM类型 (`normal`/`thinking`) |
| `--restore-session` | 从保存的会话中恢复               |
| `-e`, `--edit`      | 快速编辑配置文件                 |

### 示例

**1. 交互式对话**
启动一个交互式会话，您可以像聊天一样分配任务。
```bash
jvs
```

**2. 直接执行任务**
让 Jarvis 分析当前项目结构并生成一份报告。
```bash
jvs -t "分析当前目录下的代码，总结项目的主要模块和功能"
```

**3. 解决环境问题**
当您遇到一个复杂的环境问题时，可以请求 Jarvis 帮助。
```bash
jvs -t "我的 docker 服务无法启动，请帮我诊断问题并尝试修复。相关日志在 /var/log/docker.log"
```

## 4.3 代码代理 (`jarvis-code-agent` / `jca`)

`jca` 是专为软件开发任务设计的代理，是您日常编码、重构和调试的得力助手。

### 核心能力
-   代码分析与修改
-   自动化代码审查
-   智能问题修复
-   与Git工作流集成

### 常用参数
| 参数                | 描述                             |
| ------------------- | -------------------------------- |
| `-r`, `--requirement` | 提供代码相关的需求描述           |
| `--llm_type`        | 临时指定LLM类型 (`normal`/`thinking`) |
| `--restore-session` | 从保存的会话中恢复               |

### 示例

**1. 添加新功能**
在项目中添加一个新功能，`jca` 会自动查找相关文件并进行修改。
```bash
jca -r "在用户认证模块中，增加一个'忘记密码'的功能。需要创建一个新的API端点 /api/forgot-password，并实现发送重置邮件的逻辑。"
```

**2. 修复 Bug**
根据 Bug 描述修复问题。
```bash
jca -r "修复 src/utils/calculator.py 中的除零错误。当除数为零时，应该返回一个错误提示而不是抛出异常。"
```

**3. 代码重构**
优化现有代码。
```bash
jca -r "重构 src/services/user_service.py 文件，将其中过长的 'create_user' 方法拆分为多个更小的私有方法，提高代码可读性。"
```

## 4.4 平台管理器 (`jarvis-platform-manager` / `jpm`)

`jpm` 是您与底层大模型平台交互和管理的工具。

### 子命令
-   `info`: 显示所有支持的平台和模型。
-   `chat`: 与指定的平台和模型进行交互式对话。
-   `service`: 将指定的模型以OpenAI兼容的API形式暴露出来。
-   `role`: 加载预定义的角色进行对话。

### 示例

**1. 查看可用模型**
```bash
jpm info
```

**2. 与特定模型聊天**
直接与Kimi进行对话，测试其性能。
```bash
jpm chat -p kimi
```

**3. 启动本地API服务**
将腾讯元宝模型封装为本地API，供其他应用调用。
```bash
jpm service --host 0.0.0.0 --port 8080 -p yuanbao
```

## 4.5 Git提交助手 (`jarvis-git-commit` / `jgc`)

`jgc` 能自动分析您的代码变更，并生成符合规范的 Git 提交信息。

### 核心能力
-   自动分析 `git diff`
-   生成规范的提交信息（类型、范围、主题）
-   自动暂存和提交

### 示例

当您完成了一些代码修改后，只需在项目根目录运行：
```bash
# 确保您已经通过 git add 将变更加入暂存区
git add .

# 运行 jgc
jgc
```
Jarvis 将会分析变更，生成一条类似 `feat(auth): add password reset endpoint` 的提交信息，并自动执行 `git commit`。

## 4.6 本地知识库 (`jarvis-rag` / `jrg`)

`jrg` 用于构建和查询基于您自己文档的本地知识库。

### 子命令
-   `add`: 添加文档（文件、目录、通配符）到知识库。
-   `list-docs`: 列出知识库中的所有文档。
-   `query`: 向您的知识库提问。

### 示例

**1. 构建知识库**
将整个项目代码和文档目录添加到知识库中。
```bash
jrg add ./src ./docs README.md
```

**2. 查询知识库**
基于您添加的文档，向 Jarvis 提问。
```bash
jrg query "在我们的项目中，'PlatformRegistry' 这个类是用来做什么的？它在哪个文件里定义的？"
```
这会让AI基于您的真实代码进行回答，而不是泛泛而谈。

## 4.7 智能Shell (`jarvis-smart-shell` / `jss`)

`jss` 是一个强大的工具，可以将您的自然语言指令转换为可执行的 Shell 命令，极大降低了在终端中执行复杂操作的门槛。

### 子命令
-   `request <需求>`: 将自然语言需求转换为 Shell 命令。
-   `install`: 为 `fish` shell 安装命令补全功能，提升使用体验。
-   `uninstall`: 卸载 `fish` shell 的命令补全功能。

### 示例

**1. 将自然语言转换为命令**
假设您想查找所有大于1MB的日志文件，但记不清 `find` 命令的具体参数。
```bash
jss request "查找当前目录下所有大于1MB的.log文件"
```
Jarvis 将会返回对应的 `find` 命令，并询问您是否执行。

**2. 安装自动补全**
```bash
jss install
```

## 4.8 代码审查 (`jarvis-code-review` / `jcr`)

`jcr` 是您的自动化代码审查员，可以针对单个提交、文件或当前工作区的变更提供深入的分析和改进建议。

### 子命令
-   `commit <commit-sha>`: 审查指定的单个提交。
-   `current`: 审查您当前 `git` 工作区中已暂存和未暂存的变更。
-   `range <commit1>..<commit2>`: 审查指定范围内的所有提交。
-   `file <文件路径>`: 审查单个或多个文件。

### 示例

**1. 审查上一个提交**
```bash
jcr commit HEAD~1
```

**2. 审查当前所有变更**
在提交代码前，进行一次自我审查。
```bash
# 首先暂存你的变更
git add .
# 运行审查
jcr current
```

**3. 审查单个文件**
```bash
jcr file src/jarvis/jarvis_agent/jarvis.py
```

## 4.9 高级Git工具

除了 `jgc`，Jarvis 还提供了一系列高级 Git 工具来简化复杂操作。

### 1. 交互式Squash (`jarvis-git-squash` / `jgs`)

`jgs` 可以帮助您将从某个提交开始的所有后续提交合并成一个，并自动生成清晰的合并信息。这在合并多个小的功能提交时非常有用。

**示例**
假设您的提交历史如下，您想将 `feat-a`, `feat-b`, `fix-c` 合并成一个提交。
```
* 2d3d4d5 (HEAD -> main) fix-c
* a1b2c3d feat-b
* f9e8d7c feat-a
* c1a2b3d (base-commit) initial structure
```

运行以下命令，其中 `c1a2b3d` 是您希望开始合并的基础提交的哈希值：
```bash
jgs c1a2b3d
```
Jarvis 会自动完成 rebase 和 squash 操作，并为您生成一份总结性的 commit message。

### 2. 提交分析 (`jarvis-git-details` / `jgd`)

`jgd` 可以分析单个提交或一个提交范围，并生成一份详细的变更报告，解释每个变更的目的和实现方式。

**示例**

**1. 分析单个提交**
```bash
jgd 2d3d4d5
```

**2. 分析一个范围**
```bash
jgd --range c1a2b3d..2d3d4d5
```

## 4.10 多智能体协作 (`jarvis-multi-agent` / `jma`)

`jma` 用于编排多个不同角色的 AI 智能体协同工作，以完成需要多元化技能的复杂任务，例如市场调研、产品设计或代码开发。

### 核心参数
| 参数 | 描述 |
|---|---|
| `-c`, `--config` | 指定定义了智能体角色和工作流的YAML配置文件 |
| `-i`, `--input` | 提供给智能体系统的初始任务输入 |

### 示例

运行一个由研究员、分析师和报告撰写者组成的小组，来分析AI的最新趋势。
```bash
jma --config ./example/multi_agent/researcher.yaml --input "分析2024年人工智能领域的最新技术趋势和市场机会，并生成一份报告。"
```

## 4.11 工具管理 (`jarvis-tool` / `jt`)

`jt` 是与 Jarvis 工具系统交互的命令行界面。

### 子命令
-   `list`: 列出所有AI可用的工具及其描述。
-   `call`: 直接从命令行调用一个工具。
-   `stat`: 显示工具被AI调用的统计信息。

### 示例
```bash
# 列出所有工具
jt list

# 调用网页搜索工具（参数需为JSON格式）
jt call search_web --args '{"query": "Jarvis AI assistant on GitHub"}'
```

## 4.12 方法论管理 (`jarvis-methodology` / `jm`)

`jm` 是用于管理和维护 Jarvis 方法论库的工具。方法论是指导AI解决特定问题的预定义策略和知识。

### 子命令
-   `import`: 从文件导入方法论。
-   `export`: 将当前的方法论库导出到文件。
-   `list`: 列出所有已加载的方法论。
-   `extract`: 从本地文本文件提取并生成方法论。
-   `extract-url`: 从一个URL（如网页文章）提取并生成方法论。

### 示例
```bash
# 列出当前所有方法论
jm list

# 从一篇关于Docker问题排查的博客文章中学习，并创建新的方法论
jm extract-url "https://some-blog.com/docker-troubleshooting-guide"
```
