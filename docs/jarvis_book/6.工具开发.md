# 6. 工具开发

Jarvis 的强大之处在于其高度的可扩展性，而**自定义工具**是实现扩展的核心。通过创建自己的工具，您可以让 Jarvis 与您的私有API、内部数据库、专有系统或任何您需要的服务进行交互。

本章将指导您完成创建、测试和部署自定义工具的全过程。

## 6.1 工具的结构

一个 Jarvis 工具本质上是一个遵循特定规范的 Python 类。Jarvis 在启动时会自动扫描并加载这些类。

### 工具文件位置

您所有的自定义工具都应该放在以下目录中：

```
~/.jarvis/tools/
```

您可以在此目录下创建任意 `.py` 文件，每个文件可以包含一个或多个工具类。

### 工具类的基本规范

一个标准的工具类必须包含以下部分：

1.  `name`: (字符串) 工具的唯一名称。代理通过此名称调用工具。
2.  `description`: (字符串) 工具功能的清晰描述。AI会根据这个描述来判断何时使用该工具。
3.  `parameters`: (字典) 定义工具所需参数的 JSON Schema。这告诉AI如何正确地为工具提供输入。
4.  `execute(self, args)`: (方法) 工具的实际执行逻辑。

## 6.2 开发步骤

让我们通过一个具体的例子来演示如何创建一个新工具。假设我们需要一个工具，它能读取一个特定的 `.ini` 配置文件并返回指定 `section` 下的所有键值对。

### 第1步：创建工具文件

首先，在 `~/.jarvis/tools/` 目录下创建一个新的 Python 文件，例如 `config_reader_tool.py`。

### 第2步：编写工具类

在 `config_reader_tool.py` 文件中，写入以下代码：

```python
import configparser
from typing import Dict, Any

class IniConfigReaderTool:
    # 1. 工具名称 (必须唯一)
    name = "read_ini_config_section"
    
    # 2. 工具描述 (给AI看，必须清晰)
    description = "读取 .ini 格式的配置文件中指定 section 的所有内容。"
    
    # 3. 参数定义 (使用JSON Schema)
    parameters = {
        "type": "object",
        "properties": {
            "file_path": {
                "type": "string",
                "description": "要读取的 .ini 文件的完整路径。"
            },
            "section_name": {
                "type": "string",
                "description": "要读取的配置项所在的 section 名称。"
            }
        },
        "required": ["file_path", "section_name"]
    }
    
    # 4. 执行逻辑
    def execute(self, args: Dict[str, Any]) -> Dict[str, Any]:
        file_path = args.get("file_path")
        section_name = args.get("section_name")

        try:
            # 检查参数
            if not file_path or not section_name:
                raise ValueError("错误：必须同时提供 file_path 和 section_name。")

            config = configparser.ConfigParser()
            read_files = config.read(file_path)

            if not read_files:
                raise FileNotFoundError(f"错误：配置文件 '{file_path}' 不存在或无法读取。")

            if not config.has_section(section_name):
                raise ValueError(f"错误：在配置文件中未找到名为 '{section_name}' 的 section。")

            # 成功逻辑
            section_content = dict(config.items(section_name))
            return {
                "success": True,
                "stdout": str(section_content), # stdout 应该是字符串
                "stderr": ""
            }

        except Exception as e:
            # 失败逻辑
            return {
                "success": False,
                "stdout": "",
                "stderr": f"执行工具时发生错误: {str(e)}"
            }

```

### 第3步：测试工具

您不需要做任何额外的注册操作。只需重新启动 `jarvis` (`jvs`) 或任何其他代理，新工具就会被自动加载。

您可以通过以下方式测试它：

1.  **直接命令**: 在 Jarvis 交互模式下，输入 `'ToolUsage'` 查看工具列表，确认您的新工具已在其中。
2.  **自然语言任务**: 给 Jarvis 一个需要使用该工具的任务。例如：

    ```
    请帮我读取 /path/to/my/app.ini 文件中 [database] section 的内容。
    ```

    如果您的工具描述写得足够好，AI 应该能理解这个任务，并自动调用您刚刚创建的 `read_ini_config_section` 工具。

## 6.3 最佳实践

-   **保持原子性**: 每个工具应该只做一件事，并把它做好。复杂的逻辑应该拆分为多个工具。
-   **描述清晰**: `description` 是写给 AI 看的，这是决定您的工具能否被正确使用的最关键因素。请用清晰、无歧义的语言描述工具的功能、适用场景和限制。
-   **健壮的错误处理**: `execute` 方法必须能妥善处理各种预期的和意外的错误，并通过返回值的 `stderr` 字段向AI提供有意义的错误信息。这能帮助AI理解为什么工具执行失败，并进行相应的调整。
-   **明确的参数**: `parameters` 定义要尽可能精确。使用 `description` 字段详细解释每个参数的含义和格式要求。如果参数有枚举值，请务必在描述中列出。
-   **返回字符串**: `stdout` 和 `stderr` 字段应该是字符串格式。如果您的工具结果是一个复杂的数据结构（如字典或列表），请在返回前将其序列化为字符串（例如，使用 `str()` 或 `json.dumps()`）。
